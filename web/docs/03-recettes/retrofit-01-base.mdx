---
hide_table_of_contents: true
---

# HTTP 1 - Retrofit de base

:::tip
ATTENTION : L'outil principal de débogage pour les appels réseaux est le *Network Inspector* dans Android Studio.
1. Cliquer sur Fichier / File ou le symbole  ☰ en haut à gauche.
2. Choisir View / Tool Windows / AppInspection.
3. Dans la fenêtre AppInspection, choisir l'onglet **Network Inspector**.
4. Tu devrais voir apparaître les appels réseaux de ton application.
:::

[Retrofit](https://square.github.io/retrofit/) est une librairie qui permet de faire des appels HTTP de manière simple et efficace.

Elle est recommandée par la doc standard d'Android pour faire des appels réseaux [source](https://developer.android.com/codelabs/basic-android-kotlin-compose-getting-data-internet?hl=fr#0).

Le code de cette recette est disponible [ici](https://github.com/departement-info-cem/4N6-Mobile/tree/main/code/ComposeRetrofitBase/).

## AndroidManifest.xml

    Le premier élément est d'accorder à notre application la permission d'utiliser internet.

    Cela se fait en ajoutant la balise suivante entre les balises `<manifest>` et `<application>` dans le fichier `AndroidManifest.xml`.

    <GHCode
              repo="4N6-Mobile"
              filePath="code/ComposeRetrofitBase/app/src/main/AndroidManifest.xml"
              startLine="2"
              endLine="7"
             />

## build.gradle

    Il va falloir ajouter les dépendances permettant d'utiliser Retrofit dans le  `build.gradle.kts`.

    <GHCode
          repo="4N6-Mobile"
          filePath="code/ComposeRetrofitBase/app/build.gradle.kts"
          startLine="53"
          endLine="59"
         />



## GitHubApi.kt

    L'interface API indique à retrofit quelles actions on souhaite permettre:
    <GHCode
      repo="4N6-Mobile"
      filePath="code/ComposeRetrofitBase/app/src/main/java/ca/cem/composeretrofitbase/api/GitHubApi.kt"
     />

     Regardons en détail:

1. L'annotation `@GET` indique que c'est une requête de type GET.
2. "users/\{utilisateur\}/repos" indique l'url qui sera envoyée.
3. Le paramètre **utilisateur** va être inséré dans l'URL.
4. Le **Call\<String\>** indique que la réponse sera lue comme un String.

## RetrofitInstance.kt

    La prochaine étape est de construire un objet pour envoyer les requêtes concrètes de Retrofit:

    <GHCode
          repo="4N6-Mobile"
          filePath="code/ComposeRetrofitBase/app/src/main/java/ca/cem/composeretrofitbase/api/RetrofitInstance.kt"
         />


    Ici on va surtout s'assurer d'avoir l'url de départ qui pointe sur le bon serveur.
    Dans l'exemple, on pointe vers l'API de Github.

    Points importants:
    - Le **loggingInterceptor** permet de voir toutes les requêtes et réponses HTTP dans le logcat
    - Le niveau **BODY** affiche les en-têtes ET le contenu complet des requêtes/réponses
    - On ajoute l'interceptor au client OkHttp avec `.addInterceptor(loggingInterceptor)`
    - Cet outil est essentiel pour déboguer les problèmes d'API

## GitHubApiInstrumentationTest.kt

    Une fois qu'on a tout ça on peut appeler notre fonction.

    Le plus simple pour s'assurer du bon fonctionnement est de faire un test automatique avec **execute**

    <GHCode
      repo="4N6-Mobile"
      filePath="code/ComposeRetrofitBase/app/src/androidTest/java/ca/cem/composeretrofitbase/api/GitHubApiInstrumentationTest.kt"
    />
