---
hide_table_of_contents: true
---

# HTTP 4 - cookies et Post

:::tip
ATTENTION : L'outil principal de débogage pour les appels réseaux est le network inspector dans Android Studio.
1. Cliquer sur Fichier / File ou le symbole  ☰ en haut à gauche
2. Choisir View / Tool Windows / AppInspection
3. Dans la fenêtre AppInspection, choisir l'onglet **Network Inspector**
4. Tu devrais voir apparaître les appels réseaux de ton application
:::

Nous allons voir 2 éléments:
- comment envoyer des données en POST avec une classe de transfert
- comment implanter les cookies pour relier 2 appels ensemble


Les cookies servent à relier plusieurs requêtes dans une session HTTP.

Nous allons donc voir comment enchaîner une inscription/connexion et un appel à l'accueil des tâches.

Le code de cette recette est disponible [ici](https://github.com/departement-info-cem/4N6-Mobile/tree/main/code/ComposeRetrofitPostEtCookies/).

<Tabs queryString="recette-ecran">


    <TabItem value="SessionCookieJar.kt" label="SessionCookieJar.kt">

        On ajoute d'abord un cookie jar (un pot à cookies) pour que le client HTTP puisse stocker les cookies d'un appel à l'autre :
        <GHCode
            repo="4N6-Mobile"
            filePath="code/ComposeRetrofitPostEtCookies/app/src/main/java/ca/cem/composeretrofitbase/api/SessionCookieJar.kt"
        />

    </TabItem>


    <TabItem value="RetrofitInstance.kt" label="RetrofitInstance.kt">

        Au niveau de la configuration de Retrofit, on va ajouter la gestion des cookies.
        <GHCode
            repo="4N6-Mobile"
            filePath="code/ComposeRetrofitPostEtCookies/app/src/main/java/ca/cem/composeretrofitbase/api/RetrofitInstance.kt"
        />

        Les points importants ici:
        - on a ajouté un cookie jar (un pot à cookies) pour que le client HTTP puisse stocker les cookies d'un appel à l'autre
        - on configure le client OkHttp avec le cookie jar
        - on utilise à la fois ScalarsConverterFactory et GsonConverterFactory pour gérer différents types de réponses

    </TabItem>

    <TabItem value="KickMyBApi.kt" label="KickMyBApi.kt">

        Au niveau de l'API, nous allons définir les méthodes:
        - **inscription** qui envoie en POST un objet RequeteInscription
        - **connexion** qui envoie en POST un objet RequeteConnexion
        - **accueilTache** qui récupère l'accueil (nécessite d'être connecté via cookie)

        <GHCode
              repo="4N6-Mobile"
              filePath="code/ComposeRetrofitPostEtCookies/app/src/main/java/ca/cem/composeretrofitbase/api/KickMyBApi.kt"
             />


    </TabItem>
    
    <TabItem value="RequeteInscription.kt" label="RequeteInscription.kt">
        On aura besoin de cette classe pour envoyer une requête d'inscription :
        <GHCode
          repo="4N6-Mobile"
          filePath="code/ComposeRetrofitPostEtCookies/app/src/main/java/ca/cem/composeretrofitbase/api/RequeteInscription.kt"
         />
    </TabItem>

    <TabItem value="RequeteConnexion.kt" label="RequeteConnexion.kt">
        De même pour la connexion :
        <GHCode
          repo="4N6-Mobile"
          filePath="code/ComposeRetrofitPostEtCookies/app/src/main/java/ca/cem/composeretrofitbase/api/RequeteConnexion.kt"
         />
    </TabItem>
    
    <TabItem value="MainActivity.kt" label="MainActivity.kt">

        Dans l'interface Compose, on va pouvoir tester les trois appels:

        <GHCode
          repo="4N6-Mobile"
          filePath="code/ComposeRetrofitPostEtCookies/app/src/main/java/ca/cem/composeretrofitbase/MainActivity.kt"
          startLine="82"
          endLine="159"
         />

        Points importants:
        - Le bouton "Inscription" fait un POST avec un objet RequeteInscription
        - Le bouton "Connexion" fait un POST avec un objet RequeteConnexion
        - Le bouton "Accueil Tâches" fait un GET qui utilise automatiquement le cookie de session
        - Les réponses sont affichées dans des Cards séparées grâce à un composant réutilisable

    </TabItem>
    
    <TabItem value="KickMyBApiInstrumentationTest.kt" label="KickMyBApiInstrumentationTest.kt">

        **IMPORTANT** il faut envoyer au moins une requête à https://kickmyb-server.onrender.com/ avant de rouler
        le test pour "réveiller" le serveur.

        Le test illustre deux scénarios d'utilisation :

        <GHCode
          repo="4N6-Mobile"
          filePath="code/ComposeRetrofitPostEtCookies/app/src/androidTest/java/ca/cem/composeretrofitbase/api/KickMyBApiInstrumentationTest.kt"
          startLine="11"
          endLine="68"
         />

        Ce qu'on observe ici :
        - **Test 1**: Inscription puis accès à l'accueil
          - On s'inscrit avec un email aléatoire pour éviter les conflits
          - L'inscription nous connecte et crée un cookie de session
          - L'appel à l'accueil fonctionne car le cookie jar retourne automatiquement le cookie
        - **Test 2**: Connexion puis accès à l'accueil
          - On crée d'abord un compte avec inscription
          - On se connecte avec ce compte
          - On peut ensuite accéder à l'accueil grâce au cookie de session obtenu lors de la connexion
    </TabItem>

</Tabs>